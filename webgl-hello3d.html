<html>

<head>
<title>WebGL Hello World (3D)</title>
<script src="jquery-1.11.2.min.js"></script>
<script src="gl-matrix.js"></script>
<script src="gl-matrix-inplace.js"></script>
<script src="common.js"></script>
<script type="text/javascript">
    var gl;
    var canvas;
    var shader;
    var legacygl;
    var drawutil;
    var camera;
    var objects;
    var selected_object = -1;
    
    function draw() {
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
        var modelview = shader.uniforms.modelview;
        camera.lookAt(modelview.value);
        // zx-grid and xyz axis
        shader.set_uniforms();
        drawutil.zxgrid(10);
        drawutil.xyzaxis();
        // objects
        for (var i = 0; i < objects.length; ++i) {
            modelview.push();
            mat4.translate_ip(modelview.value, objects[i].position);
            mat4.scale_ip(modelview.value, [objects[i].scale, objects[i].scale, objects[i].scale]);
            shader.set_uniforms();
            drawutil.fill_and_line(
                function(mode) { drawutil.cube(mode, 0.1); },
                i == selected_object ? [1, 0, 0] : [0, 0.7, 1],
                [0, 0, 0]);
            modelview.pop();
        }
    };
    function onmousedown(evt) {
        if (evt.altKey) {
            camera.start_moving(
                evt.clientX, evt.clientY,
                evt.shiftKey ? "zoom" : evt.ctrlKey ? "pan" : "rotate");
            return;
        }
        // pick nearest object
        selected_object = -1;
        var candidates = [];
        for (var i = 0; i < objects.length; ++i) {
            var modelview = shader.uniforms.modelview.value;
            var projection = shader.uniforms.projection.value;
            var viewport = [0, 0, canvas.width, canvas.height];
            var win_xyz = project(objects[i].position, modelview, projection, viewport);
            if (vec2.dist([evt.clientX, canvas.height - evt.clientY], [win_xyz[0], win_xyz[1]]) < 20)
                candidates.push({ dist: vec3.dist(camera.eye, objects[i].position), index:i });
        }
        if (candidates.length > 0) {
            candidates.sort(function(a, b){return a.dist - b.dist});
            selected_object = candidates[0].index;
        }
        document.getElementById("input1").value = selected_object == -1 ? "(no object selected)" : objects[selected_object].scale;
        draw();
    };
    function onmousemove(evt) {
        if (camera.is_moving()) {
            camera.move(evt.clientX, evt.clientY);
            draw();
            return;
        }
    }
    function onmouseup(evt) {
        if (camera.is_moving()) {
            camera.finish_moving();
            return;
        }
    }
    function input1_onchange(evt) {
        if (selected_object == -1)
            return;
        objects[selected_object].scale = evt.target.value;
        draw();
    }
    function init() {
        // OpenGL context
        canvas = document.getElementById("canvas");
        input1 = document.getElementById("input1");
        gl = canvas.getContext("webgl");
        if (!gl)
            alert("Could not initialise WebGL, sorry :-(");
        // set shader
        var vertex_shader_src = "\
            attribute vec3 a_position;\
            attribute vec3 a_color;\
            varying vec3 v_color;\
            uniform mat4 u_modelview;\
            uniform mat4 u_projection;\
            void main(void) {\
                gl_Position = u_projection * u_modelview * vec4(a_position, 1.0);\
                gl_PointSize = 5.0;\
                v_color = a_color;\
            }\
            ";
        var fragment_shader_src = "\
            precision mediump float;\
            varying vec3 v_color;\
            void main(void) {\
                gl_FragColor = vec4(v_color, 1.0);\
            }\
            ";
        shader = get_shader(gl, vertex_shader_src, fragment_shader_src);
        shader.add_uniform("modelview", "Matrix4f");
        shader.add_uniform("projection", "Matrix4f");
        mat4.perspective(shader.uniforms.projection.value, 30 * Math.PI / 180, canvas.width / canvas.height, 0.1, 100);
        // utilities
        legacygl = get_legacygl(gl, shader.program);
        legacygl.add_vertex_attribute("color", 3);
        drawutil = get_drawutil(gl, legacygl);
        // app data
        camera = get_camera(canvas.width, canvas.height);
        camera.eye = [0.2, 0.5, 8];
        objects = [
            {position: [1, 2, 3], scale: 1.0},
            {position: [-1, 1, 2], scale: 1.2},
            {position: [2, -1, -1], scale: 0.7}
        ];
        // event handlers
        canvas.onmousedown = onmousedown;
        document.onmousemove = onmousemove;
        document.onmouseup = onmouseup;
        document.getElementById("input1").onchange = input1_onchange;
        // init OpenGL settings
        gl.viewport(0, 0, canvas.width, canvas.height);
        gl.enable(gl.DEPTH_TEST);
        gl.polygonOffset(1, 1);
        draw();
    };
</script>


</head>

<body onload="init();">
    <canvas id="canvas" width="640" height="480" style="border:1px solid #000000;"></canvas>
    <input type="number" id="input1" step="0.1" />
</body>

</html>
