<html>

<head>
<title>WebGL Hello World (3D)</title>
<script src="gl-matrix.js"></script>
<script src="gl-matrix-inplace.js"></script>
<script src="common.js"></script>
<script type="text/javascript">
    var gl;
    var canvas;
    var shader;
    var displist;
    var camera;
    
    function draw() {
        var modelview = shader.uniforms.modelview;
        var projection = shader.uniforms.projection;
        mat4.perspective(projection.value, 0.5, canvas.width / canvas.height, 0.1, 100);
        camera.lookAt(modelview.value);
        shader.set_uniforms();
        displist.set_drawfunc(function(){
            displist.begin(gl.LINES);
            displist.color(1, 0, 0); displist.vertex3(0, 0, 0); displist.vertex3(1, 0, 0);
            displist.color(0, 1, 0); displist.vertex3(0, 0, 0); displist.vertex3(0, 1, 0);
            displist.color(0, 0, 1); displist.vertex3(0, 0, 0); displist.vertex3(0, 0, 1);
            displist.end();
        });
        displist.draw();
    };
    function onmousedown(evt) {
        if (evt.altKey) {
            camera.start_moving(
                evt.clientX, evt.clientY,
                evt.shiftKey ? "zoom" : evt.ctrlKey ? "pan" : "rotate");
            return;
        }
    };
    function onmousemove(evt) {
        if (camera.is_moving()) {
            camera.move(evt.clientX, evt.clientY);
            draw();
            return;
        }
    }
    function onmouseup(evt) {
        if (camera.is_moving()) {
            camera.finish_moving();
            return;
        }
    }
    function init() {
        canvas = document.getElementById("canvas");
        canvas.onmousedown = onmousedown;
        canvas.onmousemove = onmousemove;
        canvas.onmouseup = onmouseup;
        gl = canvas.getContext("experimental-webgl");
        gl.viewportWidth = canvas.width;
        gl.viewportHeight = canvas.height;
        if (!gl)
            alert("Could not initialise WebGL, sorry :-(");
        var vertex_shader_src = "\
            attribute vec3 a_position;\
            attribute vec3 a_color;\
            varying vec3 v_color;\
            uniform mat4 u_modelview;\
            uniform mat4 u_projection;\
            void main(void) {\
                gl_Position = u_projection * u_modelview * vec4(a_position, 1.0);\
                v_color = a_color;\
            }\
            ";
        var fragment_shader_src = "\
            precision mediump float;\
            varying vec3 v_color;\
            void main(void) {\
                gl_FragColor = vec4(v_color, 1.0);\
            }\
            ";
        shader = get_shader(gl, vertex_shader_src, fragment_shader_src);
        shader.add_uniform("modelview", "Matrix4f");
        shader.add_uniform("projection", "Matrix4f");

        displist = get_displist(gl, shader.program);
        displist.add_vertex_attribute("color", 3);

        camera = get_camera(canvas.width, canvas.height);
    };
</script>


</head>


<body onload="init();draw();">
    <canvas id="canvas" width="640" height="480" style="border:1px solid #000000;"></canvas>
</body>

</html>
