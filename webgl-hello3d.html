<html>

<head>
<title>WebGL Hello World (3D)</title>
<script src="gl-matrix.js"></script>
<script src="gl-matrix-inplace.js"></script>
<script src="common.js"></script>
<script type="text/javascript">
    var gl;
    var canvas;
    var shader;
    var legacygl;
    var drawutil;
    var camera;
    
    function draw() {
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
        var modelview = shader.uniforms.modelview;
        camera.lookAt(modelview.value);
        function draw_cube() {
            shader.set_uniforms();
            drawutil.fill_and_line(
                function(mode) { drawutil.cube(mode, 0.1); },
                [0, 0.7, 1],
                [0, 0, 0]);
        };
        modelview.push();
        mat4.translate_ip(modelview.value, [1, 1, 1]);
        draw_cube();
        modelview.pop();
        shader.set_uniforms();
        legacygl.begin(gl.LINES);
        // grid on xz plane
        legacygl.color(0.2, 0.2, 0.2);
        var grid_size = 10;
        for (var i = -grid_size; i <= grid_size; ++i) {
            legacygl.vertex(i, 0, -grid_size);
            legacygl.vertex(i, 0,  grid_size);
            legacygl.vertex(-grid_size, 0, i);
            legacygl.vertex( grid_size, 0, i);
        }
        // xyz axis
        legacygl.color(1, 0, 0);    legacygl.vertex(0, 0, 0);    legacygl.vertex(1, 0, 0);
        legacygl.color(0, 1, 0);    legacygl.vertex(0, 0, 0);    legacygl.vertex(0, 1, 0);
        legacygl.color(0, 0, 1);    legacygl.vertex(0, 0, 0);    legacygl.vertex(0, 0, 1);
        legacygl.end();
    };
    function onmousedown(evt) {
        if (evt.altKey) {
            camera.start_moving(
                evt.clientX, evt.clientY,
                evt.shiftKey ? "zoom" : evt.ctrlKey ? "pan" : "rotate");
            return;
        }
        console.log(evt.clientX, canvas.height - evt.clientY);
    };
    function onmousemove(evt) {
        if (camera.is_moving()) {
            camera.move(evt.clientX, evt.clientY);
            draw();
            return;
        }
    }
    function onmouseup(evt) {
        if (camera.is_moving()) {
            camera.finish_moving();
            var win_xyz = project([1, 1, 1], shader.uniforms.modelview.value, shader.uniforms.projection.value, [0, 0, canvas.width, canvas.height]);
            console.log(win_xyz);
            return;
        }
    }
    function init() {
        // OpenGL context
        canvas = document.getElementById("canvas");
        gl = canvas.getContext("experimental-webgl");
        if (!gl)
            alert("Could not initialise WebGL, sorry :-(");
        // set shader
        var vertex_shader_src = "\
            attribute vec3 a_position;\
            attribute vec3 a_color;\
            varying vec3 v_color;\
            uniform mat4 u_modelview;\
            uniform mat4 u_projection;\
            void main(void) {\
                gl_Position = u_projection * u_modelview * vec4(a_position, 1.0);\
                gl_PointSize = 5.0;\
                v_color = a_color;\
            }\
            ";
        var fragment_shader_src = "\
            precision mediump float;\
            varying vec3 v_color;\
            void main(void) {\
                gl_FragColor = vec4(v_color, 1.0);\
            }\
            ";
        shader = get_shader(gl, vertex_shader_src, fragment_shader_src);
        shader.add_uniform("modelview", "Matrix4f");
        shader.add_uniform("projection", "Matrix4f");
        mat4.perspective(shader.uniforms.projection.value, 30 * Math.PI / 180, canvas.width / canvas.height, 0.1, 100);
        // utilities
        legacygl = get_legacygl(gl, shader.program);
        legacygl.add_vertex_attribute("color", 3);
        drawutil = get_drawutil(gl, legacygl);
        // app data
        camera = get_camera(canvas.width, canvas.height);
        camera.eye = [0.2, 0.5, 5];
        // event handlers
        canvas.onmousedown = onmousedown;
        document.onmousemove = onmousemove;
        document.onmouseup = onmouseup;
        // init OpenGL settings
        gl.viewport(0, 0, canvas.width, canvas.height);
        gl.enable(gl.DEPTH_TEST);
        gl.polygonOffset(1, 1);
    };
</script>


</head>


<body onload="init();draw();">
    <canvas id="canvas" width="640" height="480" style="border:1px solid #000000;"></canvas>
</body>

</html>
